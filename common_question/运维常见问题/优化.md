

# 优化

本章节主要介绍达梦数据库性能优化常见问题，为用户提供性能优化常见问题的分析和解决思路。除此之外，用户还可前往[达梦技术社区](https://eco.dameng.com/community/question/)参与更多问题讨论。

## 目录

  * [在应用中发现执行较慢的 SQL，在管理工具中执行很快](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8F%91%E7%8E%B0%E6%89%A7%E8%A1%8C%E8%BE%83%E6%85%A2%E7%9A%84%20SQL%EF%BC%8C%E5%9C%A8%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%BE%88%E5%BF%AB)
  * [如何看某条 sql 语句每个操作符的执行时间？](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#%E5%A6%82%E4%BD%95%E7%9C%8B%E6%9F%90%E6%9D%A1%20sql%20%E8%AF%AD%E5%8F%A5%E6%AF%8F%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%EF%BC%9F)
  * [disql 查看执行计划](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#disql%20%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92)
  * [大量的 DML 动作(经常做增删改查)导致表的碎片很多，最终导致查询该表性能很慢，如何解决](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#%E5%A4%A7%E9%87%8F%E7%9A%84%20DML%20%E5%8A%A8%E4%BD%9C\(%E7%BB%8F%E5%B8%B8%E5%81%9A%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5\)%E5%AF%BC%E8%87%B4%E8%A1%A8%E7%9A%84%E7%A2%8E%E7%89%87%E5%BE%88%E5%A4%9A%EF%BC%8C%E6%9C%80%E7%BB%88%E5%AF%BC%E8%87%B4%E6%9F%A5%E8%AF%A2%E8%AF%A5%E8%A1%A8%E6%80%A7%E8%83%BD%E5%BE%88%E6%85%A2%EF%BC%8C%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3)
  * [执行大批量提交删除操作时，运行效率较低](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#%E6%89%A7%E8%A1%8C%E5%A4%A7%E6%89%B9%E9%87%8F%E6%8F%90%E4%BA%A4%E5%88%A0%E9%99%A4%E6%93%8D%E4%BD%9C%E6%97%B6%EF%BC%8C%E8%BF%90%E8%A1%8C%E6%95%88%E7%8E%87%E8%BE%83%E4%BD%8E)
  * [如何对缓存中的执行计划进行过滤](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#%E5%A6%82%E4%BD%95%E5%AF%B9%E7%BC%93%E5%AD%98%E4%B8%AD%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4)
  * [如何开启结果集缓存](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#%E5%A6%82%E4%BD%95%E5%BC%80%E5%90%AF%E7%BB%93%E6%9E%9C%E9%9B%86%E7%BC%93%E5%AD%98)
  * [如何使用 DBMS_SQLTUNE 包获取 SQL 执行信息](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20DBMS_SQLTUNE%20%E5%8C%85%E8%8E%B7%E5%8F%96%20SQL%20%E6%89%A7%E8%A1%8C%E4%BF%A1%E6%81%AF)
  * [DM 二级索引中是否包含了 null 值](https://eco.dameng.com/document/dm/zh-cn/faq/faq-optimizing.html#DM%20%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E4%B8%AD%E6%98%AF%E5%90%A6%E5%8C%85%E5%90%AB%E4%BA%86%20null%20%E5%80%BC)



## 正文

## 在应用中发现执行较慢的 SQL，在管理工具中执行很快

可通过查看系统视图，及时发现活动会话中的慢 SQL，将其在计划缓存中的执行计划打印到 trc 文件中，核查是否与在管理工具中查询到的执行计划一致，偏差较大则清理缓存中执行计划。

具体方法如下：

通过 PLNDUMP 来看对应缓存中的 SQL 执行计划

  * 查找出活动会话中执行时间大于 1S 的 SQL



```
select * from (
select timestampdiff(second,s.last_recv_time,sysdate) t ,s.* 
from v$sessions s  where state='ACTIVE')
where t > 1
```

  * 找到对应慢 SQL 对应的 cache_item 值。



```
select * from v$cachepln where upper(sqlstr) like '%SQL%'
```

  * 在 trace 目录中生成对应 trc 文件



```
alter session set events 'immediate trace name plndump ,level cache_item'
```

  * 对比管理工具的执行计划和 .trc 文件中的执行计划。
  * 清理内存中执行计划缓存。



```
call sp_clear_plan_cache();
call sp_clear_plan_cache(pln号)；---不加 pln 就是清理所有 sql 缓存。
```

## 如何看某条 sql 语句每个操作符的执行时间？

  * 创建测试表



```
DROP TABLE if EXISTS TEST;
CREATE TABLE TEST (NAME VARCHAR2(200),ENTRY_DATE DATE,COMPANY VARCHAR2(200));
INSERT INTO TEST VALUES('王强',date'2008-1-1','电信');
INSERT INTO TEST VALUES('王强',date'2009-1-1','移动');
INSERT INTO TEST VALUES('王强',date'2010-1-1','联通');
INSERT INTO TEST VALUES('李四',date'2008-1-1','电网');
INSERT INTO TEST VALUES('李四',date'2009-1-1','财政局');
INSERT INTO TEST VALUES('张三',date'2012-12-1','腾讯');
INSERT INTO TEST VALUES('张三',date'2013-12-1','阿里');
INSERT INTO TEST VALUES('张三',date'2014-12-1','美团');
INSERT INTO TEST VALUES('张三',date'2015-12-1','饿了么');
COMMIT;
--SELECT * FROM TEST; --查看数据
```

![查看表数据](https://download.dameng.com/eco/docs/asset/faq/optimizing/faq-optimizing-001.png)

  * 在管理工具中执行如下语句：



```
SF_SET_SESSION_PARA_VALUE('MONITOR_SQL_EXEC',1);  
--动态打开会话级参数MONITOR_SQL_EXEC，该设置只对本会话有效,其余会话无影响
```

![动态修改参数](https://download.dameng.com/eco/docs/asset/faq/optimizing/faq-optimizing-002.png)

  * 执行 sql 语句并获取操作符执行时间



```
SELECT
        A.NAME,
        LISTAGG(A.COMPANY, '->') WITHIN GROUP (
ORDER BY
        A.ENTRY_DATE)
FROM
        TEST A
GROUP BY
        A.NAME;
```

![执行 sql 语句](https://download.dameng.com/eco/docs/asset/faq/optimizing/faq-optimizing-003.png)

依次点击“消息”，“590”，（或者执行 et(590) ）弹出如下的操作符执行时间对话框：

![获取操作符执行时间](https://download.dameng.com/eco/docs/asset/faq/optimizing/faq-optimizing-004.png)

如上图所示，该 sql 语句共涉及 6 个操作符，按照执行的先后顺序分别是 SAGR2、SORT3、NSET2、CSCN2、DLCK、PRJT2。

其中，耗时最长的操作符是 SAGR2，耗时 1072 微秒，占总执行时间的 63.47%；耗时排第二位的操作符是 SORT3，耗时 536 微秒，占总执行时间的 31.73%。

根据上述的分析，我们就需要针对这 2 个操作符进行针对性的优化。

## disql 查看执行计划

【问题说明】：
disql 中开启自动跟踪 set autotrace trace + sql ，对应的执行计划看不到统计信息是否失真的对比（估算和实际记录数），三元组中记录数只有一个数字。

【解决方法】：
该功能开启前提是 ini 参数：ENABLE_MONITOR、MONITOR_SQL_EXEC 已开启，故运行时先执行以下脚本设置参数

```
SP_SET_PARA_VALUE(1,'ENABLE_MONITOR',1);
SP_SET_PARA_VALUE(1,'MONITOR_SQL_EXEC',1);
```

分析完后，记得关闭，以免影响性能

```
SP_SET_PARA_VALUE(1,'ENABLE_MONITOR',0);
SP_SET_PARA_VALUE(1,'MONITOR_SQL_EXEC',0);'
```

![disql 查看执行计划](https://download.dameng.com/eco/docs/asset/faq/optimizing/faq-optimizing-005.png)

## 大量的 DML 动作(经常做增删改查)导致表的碎片很多，最终导致查询该表性能很慢，如何解决

【问题解决】：

达梦的数据通过 B 树维护的。可对指定索引进行空间整理，重组数据，达到优化该表的目的。具体操作如下，以 test 为例介绍：

```
---首先查看 TEST 表的索引名
select name from sysobjects where pid=(select id from sysobjects where name='TEST' and type$='SCHOBJ')and subtype$='INDEX';
---重组 TEST 表的索引
SP_REORGANIZE_INDEX('SYSDBA','INDEX33555469');
```

## 执行大批量提交删除操作时，运行效率较低

【问题描述】：

执行大批量提交删除操作时，运行效率较低，定位到 sql: delete from m_object  where  oid=?; 并且负载过高。
检查数据库没有阻塞 sql，没有锁等待，没有触发器。检查该列 oid 为主键列且执行计划也走了索引。此表数据量不到两百万，主键列的引用表个数 37 张，经常检索的引用表数据量大约 30G 左右，单条执行删除操作大约在 2-3s。

【问题解决】：

由于 M_OBJECT 表中主键列被其他表的外键约束引用，导致删除数据时会检查关联表的外键所以删除较慢，建议把外键列都加索引，约束改成 with index。
例如：alter table "M_VALUE_POLICY" modify constraint "FK_VALUE_POLICY" to foreign key("OID") references "M_OBJECT"("OID") with index;

> **注意**
>
> sql 效率执行慢原因除了外键约束引用情况，还要综合分析触发器和主备数据同步之间影响等情况。



## 如何对缓存中的执行计划进行过滤

【问题描述】

在业务系统中 sql 的执行速度，执行计划会随着数据量和数据类型变化而变化，应用需要定时对 sql 进行巡检，保证业务性能。

【问题解决】

  1. 导出数据库内全部缓存的执行计划。



```
select  'ALTER SESSION SET EVENTS ''IMMEDIATE TRACE NAME PLNDUMP,LEVEL '||cache_item||''';'  from v$cachepln ;
```

该命令执行后，会在 DAMENG/trace 目录下生成 trc 文件。

  3. 将包含 "CSCN2" 的 sql 进行梳理，过滤规则为：  
① 凡是涉及到向大量客户开放使用或常用业务中频繁使用的 sql，需要根据实际情况判断是否需要优化  
② 经过判断执行次数比较少的 sql 可以不做处理。

  4. 在导出的 trace 文件中，查找 "CSCN2"、"SSCN" 等表示全表扫描的执行计划，然后向上找到对应的 sql 文本和 cache item 编号。



## 如何开启结果集缓存

【问题描述】

开启结果集缓存策略，可大大提升 sql 执行时间，达梦数据库如何开启结果集缓存？

【问题解决】

  1. 修改 dm.ini 参数；



```
vim /dmdata/DAMENG/dm.ini

##设置参数值，开启结果集缓存
RS_CAN_CACHE=1
BUILD_FORWARD_RS=1
```

当 RS_CAN_CACHE 为 1 时，还可以通过设置 INI 参数 RS_CACHE_TABLES 和 RS_CACHE_MIN_TIME 对缓存的结果集进行限制和过滤。RS_CACHE_TABLES 指定可以缓存结果集的基表清单，只有查询涉及的所有基表全部在参数指定范围内，此查询才会缓存结果集。RS_CACHE_MIN_TIME 则指定了缓存结果集的查询语句执行时间的下限，只有实际执行时间不少于指定值的查询结果集才会缓存。

参数说明：

|**参数名**|**默认值**|**说明**|**属性**|
|---|---|---|---|
|RS_CAN_CACHE|0|结果集缓存配置。0：禁止重用结果集；1：强制模式，此时默认缓存所有结果集，但可通过 RS_CACHE_TABLES 参数和语句 HINT 进行手动设置；2：手动模式，此时默认不缓存结果集，但可通过语句 HINT 对必要的结果集进行缓存|静态|
|BUILD_FORWARD_RS|0|仅向前游标是否生成结果集。0：不生成；1：生成|静态|
|RS_CACHE_TABLES|空串|指定可以缓存结果集的基表的清单，当 RS_CAN_CACHE=1 时，只有查询涉及的所有基表全部在此参数指定范围内，该查询才会缓存结果集。当参数值为空串时，此参数失效。|手动|
|RS_CACHE_MIN_TIME||结果集缓存的语句执行时间下限，只有实际执行时间不少于指定时间值的查询，其结果集才会被缓存，仅在RS_CAN_CACHE=1 时有效。默认值 0，表示不限制；有效值范围（0~4294967294），以 MS 为单位。|动态，系统级|


  2. 验证 dm.ini 修改是否正确；



```
select * from v$dm_ini where PARA_NAME in ('RS_CAN_CACHE','BUILD_FORWARD_RS','RS_CACHE_TABLES');
```

  3. 重启数据库生效。



示例：

  1. 修改 dm.ini 参数；



```
vim /dmdata/DAMENG/dm.ini

RS_CAN_CACHE=1
BUILD_FORWARD_RS=1
RS_CACHE_TABLES=HGTEST.YBCK_CBEC_ELIST_ITEM,HGTEST.YBCK_CBEC_ELIST
```

  2. 验证 dm.ini 修改是否正确；



```
select * from v$dm_ini where PARA_NAME in ('RS_CAN_CACHE','BUILD_FORWARD_RS',
'RS_CACHE_TABLES');
```

![image.png](https://eco.dameng.com/eco-file-server/file/eco/preview/20230308102738JT7CMF44CL0KNI5MUN)

  3. 重启数据库；
  4. 验证结果集缓存。



  * 第一次查询慢 sql 需要加载所有结果集，耗时较长。



![image.png](https://eco.dameng.com/eco-file-server/file/eco/preview/20230308102817WIJ4X4VDJULJOUVOXL)

  * 第二次查询使用到结果集缓存，耗时很短。



![image.png](https://eco.dameng.com/eco-file-server/file/eco/preview/20230308102836TR2KZ40N6LTYQQ3AP1)

## 如何使用 DBMS_SQLTUNE 包获取 SQL 执行信息

【问题解决】

DBMS_SQLTUNE 包提供一系列对实时 SQL 监控的方法。当 SQL 监控功能开启后，DBMS_SQLTUNE 包可以实时监控 SQL 执行过程中的信息，包括：执行时间、执行代价、执行用户、统计信息等情况。SQL 监控功能开启的方法是将 DM.INI 参数 ENABLE_MONITOR 和 MONITOR_SQL_EXEC 均设置为 1。

具体操作步骤：

  1. 设置 disql 界面显示长度。



```
SET LONG 9999999
```

  2. 打开 MONITOR_SQL_EXEC。



```
sf_set_session_para_value('MONITOR_SQL_EXEC',1);
```

  3. 执行需要调优的 SQL，例如如下 SQL：



```
select * from t1
```

![image.png](https://eco.dameng.com/eco-file-server/file/eco/preview/20230517104525R9TPXFNQG8LBBZX7HA)

  4. 调用 DBMS_SQLTUNE.REPORT_SQL_MONITOR，传入执行 ID 1213701。



```
select DBMS_SQLTUNE.REPORT_SQL_MONITOR(SQL_EXEC_ID=>1213701) from dual;
```

![image.png](https://eco.dameng.com/eco-file-server/file/eco/preview/20230517104625NHVR7UDHFQWRVH1O27)

> **注意**
>
> 数据库监控开启后对数据库性能有一定的影响，使用完毕后需及时关闭。



## DM 二级索引中是否包含了 null 值

【问题描述】

Oracle 数据库索引中不包含 null 值，因此 where 条件通过 null 值查询，无法使用索引，那么 DM 二级索引中是否包含了 null 值呢？

【问题分析】

验证步骤：

  1. 创建测试表及索引。



```
create table t as select rownum id,md5(rownum) c1 from dual connect by rownum < 100000;
create index idxt on t(c1);
update t set c1=null where id=100;
commit;
```

  2. 通过 null 条件查询。



```
select * from t where c1 is null;
1   #NSET2: [2, 2499, 68]
2     #PRJT2: [2, 2499, 68]; exp_num(3), is_atom(FALSE)
3       #BLKUP2: [2, 2499, 68]; IDXT(T)
4         #SSEK2: [2, 2499, 68]; scan_type(ASC), IDXT(T), scan_range[NULL,NULL], is_global(0)
```

从执行计划可知，使用了二级索引扫描，因此可以确定，DM 二级索引中存储了索引列 null 值。

## 如何查询 sql 被数据库哪些已绑定的 hint 匹配到

【问题描述】

如何查询 sql 被数据库哪些已绑定的 hint 匹配到，进而影响了执行计划。

【问题解决】

可使用下面语句进行查询获取：

```
select
        name                     ,
        dbms_lob.substr(sql_text) sql_text,
        dbms_lob.substr(hint_text) hint_text,
  CRTDATE
from
        sysinjecthint
where
'查询的sql' like CONCAT('%',sql_text,'%')order by
        crtdate ;
```
