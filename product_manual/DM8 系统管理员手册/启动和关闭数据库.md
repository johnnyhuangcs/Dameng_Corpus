

# 启动和关闭数据库

DM 支持多种操作系统。常用的操作系统基本上可以划分为 Windows 操作系统和 Linux 操作系统。下面分别介绍这两种操作系统下启动和关闭 DM 数据库的操作。

## 7.1 启动数据库

### 7.1.1 Windows 系统

  1. **菜单方式**



安装 DM 数据库后(默认情况下安装成功后 DM 服务会自动启动)，在 Windows 的开始菜单选项中选择如图 7.1 所示的菜单项中的 DM 服务查看器可以启动 DM 数据库。

![DM 数据库菜单方式启动 1](https://download.dameng.com/eco/docs/asset/pm/admin-manual/图7.1-DM数据库菜单方式启动1.png)

图7.1 DM数据库菜单方式启动1

点击 DM 服务查看器选项后，会弹出如图 7.2 所示的界面：

![DM 数据库菜单方式启动 2](https://download.dameng.com/eco/docs/asset/pm/admin-manual/图7.2-DM数据库菜单方式启动2.png)

图7.2 DM数据库菜单方式启动2

在弹出界面中选中所要启动的数据库，点击鼠标右键，在菜单栏中选择启动。

  2. **Windows 服务方式**



安装 DM 数据库并且新建一个 DM 实例后。Windows 的服务中会自动增加一项和该实例名对应的服务。例如：新建一个实例名为 DMSERVER 的 DM 数据库，Windows 的服务中会增加一项名称为“DmServiceDMSERVER”的服务。打开 Windows 的管理工具，选择“服务”，打开 Windows 服务控制台，如图 7.3 所示，选择“DmServiceDMSERVER”，用鼠标在工具栏点击启动按钮或者点击鼠标右键，在菜单栏中选择“启动”，启动 DM 数据库。

![DM 数据库服务方式启动](https://download.dameng.com/eco/docs/asset/pm/admin-manual/图7.3-DM数据库服务方式启动.png)

图7.3 DM数据库服务方式启动

  3. **命令行方式**



进入 DM 安装目录下的 bin 目录，直接打开应用程序 DMSERVER 就可以启动 DM 数据库。或者先打开 Windows 命令提示符工具，在命令工具中执行命令进入 DM 服务器的目录，再执行 DMSERVER 的命令启动 DM 数据库，如图 7.4 所示。

![DM 数据库命令行方式启动](https://download.dameng.com/eco/docs/asset/pm/admin-manual/图7.4-DM数据库命令行方式启动.png)

图7.4 DM数据库命令行方式启动

启动 DMSERVER 时，可指定 dm.ini 文件的路径、非控制台方式启动、指定数据库是否以 MOUNT 状态启动等启动参数。DMSERVER 启动时也可不指定任何参数，缺省使用当前目录下的 dm.ini 文件，如果当前目录不存在 dm.ini 文件，则无法启动。

命令行方式启动参数如下：

```
dmserver.exe [[path=]ini_file_path][dcr_ini=dcr_path][-noconsole] [mount][dpc_mode=mode][upd_lic=value][recover_check=value][enable_mac]
```

参数说明：

path：dm.ini 绝对路径。缺省为 DMSERVER 当前目录的 dm.ini；

dcr_ini：如果使用 css 集群环境，指定 dmdcr.ini 文件路径；

-noconsole：以服务方式启动。如果以此方式启动，则无法通过在控制台中输入服务器命令；

mount：以 MOUNT 配置状态启动，关于更多数据库状态见 7.2 [数据库状态和模式](#_数据库状态和模式)介绍；

dpc_mode：指定 DPC 中的实例角色，缺省为 0。0：无；1：MP；2：BP；3：SP，取值 1/2/3 时也可以用 MP/BP/SP 代替；

upd_lic：是否升级服务器安全版本信息。0：否；1：自动升级；2：强制升级。缺省为 0。一般情况下无需使用该参数。取值 1 和 2 专门用于将非安全版的系统升级为安全版的特殊场景：在当前非安全系统中放入安全版 dm.key 之后，以 upd_lic=1 方式启动服务器，系统会检查当前的版本信息，并将非安全版的系统升级为安全版，而对于已经是安全版的情况，检查版本标记后不会进行升级操作；以 upd_lic=2 方式启动服务器，不管之前是否是安全版本，均会强制进行升级的相关操作，主要用于处理之前升级失败但却设置了版本标记的特殊错误情况。升级之后再次启动 DMSERVER 时无需再指定 upd_lic 参数；

recover_check：是否检查数据库启动前有没有执行更新 DB_MAGIC（即检查数据恢复状态，具体说明可以查看《DM8 备份与还原》）。0：不检查；1：检查；缺省为 1。当该参数设置为 0 时，允许在执行更新 DB_MAGIC 之前以备库配置状态启动数据库，并进行只读操作；

enable_mac：是否开启强制访问控制功能，仅在当前库是安全版时或者非安全版通过 upd_lic 升级为安全版时有效。取值为 1 表示启用，此时参数 ENABLE_MAC 在系统中被赋值为 1；取值为 0 表示不启用，此时参数 ENABLE_MAC 在系统中被赋值为 2。缺省值为 0。开启成功后后续启动无需再添加 enable_mac 参数；

help：打印帮助信息。

当不确定启动参数的使用方法时，可以使用 help 参数，将打印出格式、参数说明和使用示例。使用方法如下：

```
dmserver help
```

当以控制台方式启动 DMSERVER 时，用户可以在控制台输入一些命令，服务器将在控制台打印出相关信息或执行相关操作。支持的命令见下表。

表7.1 DMSERVER控制台支持的命令

|**命令**|**操作**|
|--|--|
|exit|退出服务器|
|lock|打印锁系统信息|
|trx|打印等待事务信息|
|ckpt|设置检查点|
|buf|打印内存池中缓冲区的信息|
|mem|打印服务器占用内存大小|
|session|打印连接个数|
|debug|打开 DEBUG 模式|


### 7.1.2 Linux 系统

  1. **菜单方式**



安装 DM 数据库后(默认情况下安装成功后 DM 服务会自动启动)，在 Linux 的开始菜单选项中选择启动服务器菜单项可以启动 DM 数据库。启动方式类似 Windows。

  2. **Linux 服务方式**



安装 DM 数据库后，在/etc/rc.d/init.d 中有名称为 DmService 开头的文件，文件全名为 DmService+ 实例名（例如：如果实例名为 DMSERVER，则相对应的服务文件为 DmServiceDMSERVER）。以实例名为 DMSERVER 为例，在终端输入./DmServiceDMSERVER start 或者 service DmServiceDMSERVER start 即可启动 DM 数据库。

  3. **命令行方式**



在终端进入 DM 安装目录下的 bin 目录，执行./dmserver 启动 DM 数据库，参数选项同 Windows。

### 7.1.3 检查 LICENSE

无论是在何种操作系统下运行，DM 数据库在启动时都会进行 LICENSE 检查。

LICENSE 内容包括许可证版本号、LICENSE 文件序列号、服务器版本类型、服务器发布类型、服务器版本号、有效日期等。可通过查看 V$LICENSE 了解所安装的 DM 数据库的 LICENSE 信息。

LICENSE 文件为 dm.key。LICENSE 过期会导致 DM 服务器会强制退出。

LICENSE 类型须与 DM 软件类型相匹配。例如安全版的 DM 安装软件须使用安全版的 LICENSE(即安全版 dm.key)。

当服务器以 UPD_LIC=1 或 UPD_LIC=2 参数启动服务器，如果之前是非安全版的环境，当前的 dm.key 是安全版的 KEY，服务器将会从非安全版环境升级为安全版。

## 7.2 数据库状态和模式

DM 数据库包含以下几种状态：

  1. 配置状态（MOUNT）：不允许访问数据库对象，只能进行控制文件维护、归档配置、数据库模式修改等操作；
  2. 打开状态（OPEN）：不能进行控制文件维护、归档配置等操作，可以访问数据库对象，对外提供正常的数据库服务；
  3. 挂起状态（SUSPEND）：与 OPEN 状态的唯一区别就是，限制磁盘写入功能；一旦修改了数据页，触发 REDO 日志、数据页刷盘，当前用户将被挂起。



OPEN 状态与 MOUNT 和 SUSPEND 能相互转换，但是 MOUNT 和 SUSPEND 之间不能相互转换。

DM 数据库包含以下几种模式：

  1. 普通模式（NORMAL）：用户可以正常访问数据库，操作没有限制；
  2. 主库模式（PRIMARY）：用户可以正常访问数据库，所有对数据库对象的修改强制生成 REDO 日志，在归档有效时，发送 REDO 日志到备库；
  3. 备库模式（STANDBY）：接收主库发送过来的 REDO 日志并重做。数据对用户只读。



三种模式只能在 MOUNT 状态下设置，模式之间可以相互转换。

对于新初始化的库，首次启动不允许使用 mount 方式，需要先正常启动并正常退出，然后才允许 mount 方式启动。

一般情况下，数据库为 NORMAL 模式，如果不指定 MOUNT 状态启动，则自动启动到 OPEN 状态。

在需要对数据库配置时（如配置数据守护），服务器需要指定 MOUNT 状态启动。当数据库模式为非 NORMAL 模式（PRIMARY、STANDBY 模式），无论是否指定启动状态，服务器启动时自动启动到 MOUNT 状态。

## 7.3 关闭数据库

### 7.3.1 Windows 系统

  1. **菜单方式**



在 Windows 的开始->程序菜单中选择达梦数据库->DM 服务查看器，在弹出的界面中，选中要关闭的数据库，点击鼠标右键，在菜单栏中选择停止。

  2. **Windows 服务方式**



安装 DM 数据库并且新建一个 DM 实例后。Windows 的服务中会自动增加一项和该实例名对应的服务。例如：新建一个实例名为 DMSERVER1 的 DM 数据库，Windows 的服务中会增加一项名称为“DmServiceDMSERVER1”的服务。打开 Windows 的管理工具，选择服务，打开 Windows 服务控制台，如图 7.5 所示，选择“DmServiceDMSERVER1”，用鼠标在工具栏点击停止按钮或者点击鼠标右键，在菜单栏中选择停止，关闭 DM 数据库。

![图 7.5 DM 数据库服务方式停止.png](https://eco.dameng.com/eco-file-server/file/eco/preview/202306141048552MSAI0L4OPK4S8AEPK)

图7.5 DM数据库服务方式停止

  3. **命令行方式**



在启动数据库的命令工具中输入 exit，然后回车，关闭 DM 数据库。如图 7.6 所示。

![DM 数据库命令行方式停止](https://download.dameng.com/eco/docs/asset/pm/admin-manual/图7.6-DM数据库命令行方式停止.png)

图7.6 DM数据库命令行方式停止

### 7.3.2 Linux 系统

  1. **菜单方式**



在 Linux 的开始菜单中选择关闭数据库的菜单项可以关闭 DM 数据库。关闭方式类似 Windows。

  2. **Linux 服务方式**



进入/etc/rc.d/init.d，以实例名为 DMSERVER 为例，在命令行工具中输入./DmServiceDMSERVER stop 即可关闭 DM 数据库。

  3. **命令行方式**



在启动数据库的命令工具中输入 exit，然后回车，退出 DM 数据库。关闭方式类似 Windows。
